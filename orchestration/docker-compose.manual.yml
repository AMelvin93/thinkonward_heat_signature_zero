# Docker Compose v2.4 - Required for cpuset CPU pinning
version: "2.4"

# Docker Compose for MANUAL multi-worker orchestration with Research Orchestrator
# 4 containers: W0 (orchestrator) + W1, W2, W3 (experiment workers)
#
# CRITICAL: CPU PINNING FOR ACCURATE TIMING
# =========================================
# Each worker container is pinned to dedicated CPU cores to prevent contention
# and ensure timing matches G4dn.2xlarge (8 vCPUs, 32GB RAM).
#
# CPU Layout (32-core system):
#   - W1: cores 0-7   (8 cores) - mirrors G4dn.2xlarge
#   - W2: cores 8-15  (8 cores) - mirrors G4dn.2xlarge
#   - W3: cores 16-23 (8 cores) - mirrors G4dn.2xlarge
#   - W0: cores 24-27 (4 cores) - orchestrator (no experiments)
#   - Host OS: cores 28-31 (4 cores reserved)
#
# This ensures each experiment worker has ISOLATED resources matching the
# competition submission environment.
#
# Usage:
#   # Start all 4 containers
#   docker-compose -f orchestration/docker-compose.manual.yml up -d
#
#   # Attach to each container (in separate terminals)
#   docker exec -it claude-orchestrator bash    # W0 - Research Orchestrator
#   docker exec -it claude-worker-1 bash        # W1 - Threshold Tuning
#   docker exec -it claude-worker-2 bash        # W2 - Init Strategies
#   docker exec -it claude-worker-3 bash        # W3 - Feval Allocation
#
#   # In each container:
#   claude login
#   cat /workspace/orchestration/shared/prompt_W0.txt  # (or W1, W2, W3)
#   claude --dangerously-skip-permissions
#   # Paste the prompt
#
#   # Stop all
#   docker-compose -f orchestration/docker-compose.manual.yml down

services:
  # ===================================================================
  # W0 - RESEARCH ORCHESTRATOR
  # Monitors results, researches new approaches, prioritizes queue
  # Does NOT run experiments - only analyzes and guides workers
  # ===================================================================
  orchestrator:
    build:
      context: ..
      dockerfile: Dockerfile.dev
    image: heat-signature-zero:latest
    container_name: claude-orchestrator
    hostname: orchestrator

    # Orchestrator uses fewer resources (no experiments)
    # Pinned to cores 24-27 (4 cores)
    cpus: '4'
    cpuset: "24-27"
    mem_limit: 16g

    volumes:
      - ..:/workspace
      - claude-creds-w0:/root/.claude

    environment:
      - PYTHONUNBUFFERED=1
      - WORKER_ID=W0
      - PS1=\[\e[35m\][W0-ORCH]\[\e[0m\] \w\$$

    working_dir: /workspace
    stdin_open: true
    tty: true

    command: >
      bash -c "
        echo '========================================';
        echo 'W0 - RESEARCH ORCHESTRATOR';
        echo '========================================';
        echo '';
        echo 'ROLE: Monitor, Research, Prioritize';
        echo '  - Analyze experiment results';
        echo '  - Research new techniques (WebSearch)';
        echo '  - Update queue.json with priorities';
        echo '  - Guide workers through insights';
        echo '';
        echo 'DOES NOT run experiments!';
        echo '';
        echo 'CPU: Pinned to cores 24-27';
        echo '';
        echo 'SETUP:';
        echo '  1. Run: claude login';
        echo '  2. Run: cat /workspace/orchestration/shared/prompt_W0.txt';
        echo '  3. Run: claude --dangerously-skip-permissions';
        echo '  4. Paste the prompt from step 2';
        echo '';
        echo 'Container ready. Waiting...';
        tail -f /dev/null
      "

  # ===================================================================
  # W1 - EXPERIMENT WORKER (Threshold Tuning focus)
  # PINNED TO CORES 0-7 - Mirrors G4dn.2xlarge (8 vCPUs)
  # ===================================================================
  worker1:
    build:
      context: ..
      dockerfile: Dockerfile.dev
    image: heat-signature-zero:latest
    container_name: claude-worker-1
    hostname: worker1

    # G4dn.2xlarge equivalent: 8 vCPUs, 32GB RAM
    # PINNED to dedicated cores 0-7 for accurate timing
    cpus: '8'
    cpuset: "0-7"
    mem_limit: 32g

    volumes:
      - ..:/workspace
      - claude-creds-w1:/root/.claude

    environment:
      - PYTHONUNBUFFERED=1
      - WORKER_ID=W1
      - N_WORKERS=7
      - PS1=\[\e[32m\][W1]\[\e[0m\] \w\$$

    working_dir: /workspace
    stdin_open: true
    tty: true

    command: >
      bash -c "
        echo '========================================';
        echo 'W1 - Threshold Tuning (default focus)';
        echo '========================================';
        echo '';
        echo 'CPU: Pinned to cores 0-7 (G4dn.2xlarge equivalent)';
        echo 'RAM: 32GB isolated';
        echo '';
        echo 'Timing should now match submission environment!';
        echo '';
        echo 'SETUP:';
        echo '  1. Run: claude login';
        echo '  2. Run: cat /workspace/orchestration/shared/prompt_W1.txt';
        echo '  3. Run: claude --dangerously-skip-permissions';
        echo '  4. Paste the prompt from step 2';
        echo '';
        echo 'Container ready. Waiting...';
        tail -f /dev/null
      "

  # ===================================================================
  # W2 - EXPERIMENT WORKER (Init Strategies focus)
  # PINNED TO CORES 8-15 - Mirrors G4dn.2xlarge (8 vCPUs)
  # ===================================================================
  worker2:
    build:
      context: ..
      dockerfile: Dockerfile.dev
    image: heat-signature-zero:latest
    container_name: claude-worker-2
    hostname: worker2

    # G4dn.2xlarge equivalent: 8 vCPUs, 32GB RAM
    # PINNED to dedicated cores 8-15 for accurate timing
    cpus: '8'
    cpuset: "8-15"
    mem_limit: 32g

    volumes:
      - ..:/workspace
      - claude-creds-w2:/root/.claude

    environment:
      - PYTHONUNBUFFERED=1
      - WORKER_ID=W2
      - N_WORKERS=7
      - PS1=\[\e[33m\][W2]\[\e[0m\] \w\$$

    working_dir: /workspace
    stdin_open: true
    tty: true

    command: >
      bash -c "
        echo '========================================';
        echo 'W2 - Init Strategies (default focus)';
        echo '========================================';
        echo '';
        echo 'CPU: Pinned to cores 8-15 (G4dn.2xlarge equivalent)';
        echo 'RAM: 32GB isolated';
        echo '';
        echo 'Timing should now match submission environment!';
        echo '';
        echo 'SETUP:';
        echo '  1. Run: claude login';
        echo '  2. Run: cat /workspace/orchestration/shared/prompt_W2.txt';
        echo '  3. Run: claude --dangerously-skip-permissions';
        echo '  4. Paste the prompt from step 2';
        echo '';
        echo 'Container ready. Waiting...';
        tail -f /dev/null
      "

  # ===================================================================
  # W3 - EXPERIMENT WORKER (Feval Allocation focus)
  # PINNED TO CORES 16-23 - Mirrors G4dn.2xlarge (8 vCPUs)
  # ===================================================================
  worker3:
    build:
      context: ..
      dockerfile: Dockerfile.dev
    image: heat-signature-zero:latest
    container_name: claude-worker-3
    hostname: worker3

    # G4dn.2xlarge equivalent: 8 vCPUs, 32GB RAM
    # PINNED to dedicated cores 16-23 for accurate timing
    cpus: '8'
    cpuset: "16-23"
    mem_limit: 32g

    volumes:
      - ..:/workspace
      - claude-creds-w3:/root/.claude

    environment:
      - PYTHONUNBUFFERED=1
      - WORKER_ID=W3
      - N_WORKERS=7
      - PS1=\[\e[34m\][W3]\[\e[0m\] \w\$$

    working_dir: /workspace
    stdin_open: true
    tty: true

    command: >
      bash -c "
        echo '========================================';
        echo 'W3 - Feval Allocation (default focus)';
        echo '========================================';
        echo '';
        echo 'CPU: Pinned to cores 16-23 (G4dn.2xlarge equivalent)';
        echo 'RAM: 32GB isolated';
        echo '';
        echo 'Timing should now match submission environment!';
        echo '';
        echo 'SETUP:';
        echo '  1. Run: claude login';
        echo '  2. Run: cat /workspace/orchestration/shared/prompt_W3.txt';
        echo '  3. Run: claude --dangerously-skip-permissions';
        echo '  4. Paste the prompt from step 2';
        echo '';
        echo 'Container ready. Waiting...';
        tail -f /dev/null
      "

# Named volumes to persist Claude credentials
volumes:
  claude-creds-w0:
  claude-creds-w1:
  claude-creds-w2:
  claude-creds-w3:
